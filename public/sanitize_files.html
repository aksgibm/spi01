<!DOCTYPE HTML>
<html>
<head>
	<link href="//code.jquery.com/ui/1.12.1/themes/black-tie/jquery-ui.css" rel="stylesheet" type="text/css" />
<style type="text/css">
html,body{
	font-family:'Lucida Grande','Hiragino Kaku Gothic ProN', 'ヒラギノ角ゴ ProN W3',Meiryo, メイリオ, sans-serif;
}
.textfield{
	width:45%;
}
</style>
</head>
<body>
<label>追加の人名:<input type="text" id="extnames" style="width:90%;"placeholder="追加で伏字にしたい人名があれば指定してください"/></label><br/>
<label>入力フォルダ：<input type="file" webkitdirectory directory id="infolder"/></label>
<button style="vertical-align:top;" id="sanitize">変換</button>
<button style="vertical-align:top;" id="sanitize_compress">変換+圧縮</button>
<div><label>入力ファイル：<ul id="files"></ul></label></div>
<label>結果：<div id="output"></div></label>
<script src="//code.jquery.com/jquery-3.1.0.min.js"   integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s="   crossorigin="anonymous"></script>
<script src="//code.jquery.com/ui/1.12.1/jquery-ui.min.js"   integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="   crossorigin="anonymous"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.js" type="text/javascript"></script>
<script src="./js/kuromoji/kuromoji.js" type="text/javascript"></script>
<script src="./js/sanitize.js" type="text/javascript"></script>
<script type="text/javascript">
(function($){
	var infolder = null;
	var outfolder = null;
	var removeprev = false;
	function _append_msg(msg, level){
		if(removeprev){
			$("#output").empty();
			removeprev = false;
		}
		$("<div/>",{
			"class":"msg" + (level ? " " + level : "")
		}).html(msg).appendTo($("#output"));
		if("loading" == level){
			removeprev = true;
		}
	}
	var files = null;
	function _is_conversion_available(){
		return files && files.length;
	}
	function _validate_sanitlize_button(){
		$("#sanitize").prop("disabled", !_is_conversion_available());
		$("#sanitize_compress").prop("disabled", !_is_conversion_available());
	}
	_validate_sanitlize_button();
	$("#infolder").on("change", function(){
		files = Array.prototype.slice.call(this.files);
		_validate_sanitlize_button();
		$("#files").empty();
		files.forEach(function(file){
			return $("<li/>").html(file.name).appendTo($("#files"));
		});
	});
	function _clear_fs(fs){
		var reader = fs.root.createReader();
		var __read = function(){
			reader.readEntries(function(results){
				if(results.length){
					Array.prototype.slice.call(results).forEach(function(file){
						file.remove(function(){
							//console.log("removed");
						});
					});
					__read();
				}
			});
		};
		__read();
	}
	function _sanitize_files(options){
		var opt = options || {};
		return new Promise(function(resolve, reject){
			var totalsize = files.reduce(function(prev,cur){
				return prev + cur.size;
			},0);
			window.webkitRequestFileSystem(window.PERSISTENT, totalsize * 2, function(fs){
				_clear_fs(fs);
				var extnames = $("#extnames").val();
				var rem = files.length;
				if(!rem){
					resolve(rem);
				}
				var zip = new JSZip();
				files.forEach(function(file){
					var reader = new FileReader();
					reader.onload = function(e){
						sanitize_text({
							"extfilters": extnames ? extnames.split(",").map(function(nm){
								return new RegExp(nm.trim(), "g");
							}) : undefined,
							"text":e.target.result
						}).then(function(res){
							if(opt.onresult){
								opt.onresult(fs, file.name, res.result);
							}
							rem --;
							if(0 == rem){
								if(opt.onfinish){
									opt.onfinish(fs);
								}
								resolve(files.length);
							}
						}).catch(function(err){
							_append_msg(file.name + " - error on tokeinze: " + err, "error");
						});
					};
					reader.readAsText(file);
				});
			},function(e){
				reject("" + e);
			});
		});
	}
	$("#sanitize").click(function(){
		var self = $(this);
		self.prop("disabled",true);
		_append_msg("変換中...","loading");
		_sanitize_files({
			"onresult": function(fs, name, result){
				fs.root.getFile(name, {
					"create": true,
					"exclusive": false
				}, function(outfile){
					outfile.createWriter(function(fwriter){
						fwriter.onwriteend = function(e){
							_append_msg("<a target='_blank' href='filesystem:" + location.origin + "/persistent/" + name + "'>" + name + " - done. </a>", "info");
						};
						fwriter.onerror = function(e){
							_append_msg(name + " - error on writing: "+ e, "error");
						};
						var bb = new Blob([result], {"type": "text/plain"});
						fwriter.write(bb);
					});
				},function(e){
					_append_msg(name + " - error on getting output file: " + e);
				});
			}
		}).then(function(num){
			self.prop("disabled",false);
		}).catch(function(errmsg){
			self.prop("disabled",false);
			_append_msg(errmsg, "error");
		});
	});
	function _fmt_date(dt, frmt){
		if(frmt){
			return frmt.replace(/YYYY/g,dt.getFullYear())
			.replace(/MM/g, ("0" + (dt.getMonth() + 1)).slice(-2))
			.replace(/DD/g, ("0" + (dt.getDate())).slice(-2))
			.replace(/hh/g, ("0" + (dt.getHours())).slice(-2))
			.replace(/mm/g, ("0" + (dt.getMinutes())).slice(-2))
			.replace(/ss/g, ("0" + (dt.getSeconds())).slice(-2));
		}else{
			return "" + dt;
		}
	}
	$("#sanitize_compress").click(function(){
		var self = $(this);
		var self = $(this);
		self.prop("disabled",true);
		_append_msg("変換+圧縮中...","loading");
		var zip = new JSZip();
		_sanitize_files({
			"onresult": function(fs, name, result){
				zip.file(name, result);
			},
			"onfinish": function(fs){
				var zipname = _fmt_date(new Date(), "YYYYMMDDThhmmss") + ".zip";
				fs.root.getFile(zipname, {
					"create": true,
					"exclusive": false
				}, function(zipfile){
					zipfile.createWriter(function(fwriter){
						fwriter.onwriteend = function(e){
							_append_msg("<a target='_blank' href='filesystem:" + location.origin + "/persistent/" + zipname + "'>" + zipname + " - done. </a>", "info");
						}
						fwriter.onerror = function(e){
							_append_msg(zipname + " - error on writing: "+ e, "error");
						};
						zip.generateAsync({
							"compression": "DEFLATE",
							"type":"blob"
						})
						.then(function(bb){
							fwriter.write(bb);
						});
					});
				},function(e){
					_append_msg(zipname + " - error on getting output file: " + e);
				});
			}
		}).then(function(num){
			self.prop("disabled",false);
		}).catch(function(errmsg){
			self.prop("disabled",false);
			_append_msg(errmsg, "error");
		});
	});
})(jQuery);

</script>
</body>
</html>