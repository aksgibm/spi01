<!DOCTYPE HTML>
<html>
<head>
	<link href="//code.jquery.com/ui/1.12.1/themes/black-tie/jquery-ui.css" rel="stylesheet" type="text/css" />
<style type="text/css">
html,body{
	font-family:'Lucida Grande','Hiragino Kaku Gothic ProN', 'ヒラギノ角ゴ ProN W3',Meiryo, メイリオ, sans-serif;
}
.textfield{
	width:45%;
}
</style>
</head>
<body>
<label>追加の人名:<input type="text" id="extnames" style="width:90%;"placeholder="追加で伏字にしたい人名があれば指定してください"/></label><br/>
<label>入力フォルダ<input type="file" webkitdirectory directory id="infolder"/></label>
<label>出力フォルダ<input type="file" webkitdirectory directory id="outfolder"/></label>
<button style="vertical-align:top;" id="sanitize">変換</button>
<div id="output">結果</div>
<script src="//code.jquery.com/jquery-3.1.0.min.js"   integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s="   crossorigin="anonymous"></script>
<script src="//code.jquery.com/ui/1.12.1/jquery-ui.min.js"   integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="   crossorigin="anonymous"></script>
<script src="./js/kuromoji/kuromoji.js" type="text/javascript"></script>
<script src="./js/sanitize.js" type="text/javascript"></script>
<script type="text/javascript">
(function($){
	var infolder = null;
	var outfolder = null;
	function _append_msg(msg, level){
		$("<div/>",{
			"class":"msg" + (level ? " " + level : "")
		}).html(msg).appendTo($("#output"));
	}
	$("#infolder").on("change", function(){
		var files = this.files;
		var totalsize = files.reduce(function(prev,cur){
			return (prev || 0) + cur.size;
		}); 
		window.requestFileSystem(window.PERSISTENT, totalsize * 2, function(fs){
			var output = $("#output").empty();
			var extnames = $("#extnames").val();
			for(var i = 0; i < files.length;i++){
				(function(file){
					var reader = new FileReader();
					reader.onload = function(e){
						sanitize_text({
							"extfilters": extnames ? extnames.split(",").map(function(nm){
								return new RegExp(nm.trim(), "g");
							}) : undefined,
							"text":e.target.result
						}).then(function(res){
							fs.root.getFile(file.name, {
								"create": true,
								"exclusive": false
							}, function(outfile){
								outfile.createWriter(function(fwriter){
									fwriter.onwriteend = function(e){
										_append_msg(file.name + " - done.", "info");
									};
									fwriter.onerror = function(e){
										_append_msg(file.name + " - error on writing: "+ e, "error");
									};
									var bb = new BlobBuilder();
									bb.append(res.result);
									fwriter.write(bb.getBlob("text/plain"));
								});
							},function(e){
								_append_msg(file.name + " - error on getting output file: " + e);
							});
						}).catch(function(err){
							_append_msg(file.name + " - error on tokeinze: " + err, "error");
						});
					};
					reader.readAsText(file);
				})(files[i]);
			}
		},function(e){
			_append_msg("" + e, "error");
		});
	});
})(jQuery);

</script>
</body>
</html>